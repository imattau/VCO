import fs from "node:fs/promises";
import path from "node:path";
import { fileURLToPath } from "node:url";

const SOURCE_URL = "https://raw.githubusercontent.com/multiformats/multicodec/master/table.csv";
const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.resolve(scriptDir, "..");
const outPath = path.join(projectRoot, "packages/vco-core/src/generated/multicodec.codes.ts");

const response = await fetch(SOURCE_URL);
if (!response.ok) {
  throw new Error(`Failed to fetch multicodec table: ${response.status} ${response.statusText}`);
}

const csv = await response.text();
const lines = csv.split(/\r?\n/).slice(1).filter(Boolean);

const parsedCodes = lines
  .map((line) => line.split(",")[2]?.trim() ?? "")
  .filter((code) => /^0x[0-9a-f]+$/i.test(code))
  .map((code) => Number.parseInt(code, 16));

const uniqueSortedCodes = [...new Set(parsedCodes)].sort((left, right) => left - right);

const out = `/* eslint-disable */
// Generated by scripts/generate-multicodec-registry.mjs.
// Source: ${SOURCE_URL}
// Generated: ${new Date().toISOString()}

export const KNOWN_MULTICODEC_CODES: readonly number[] = Object.freeze([${uniqueSortedCodes.join(",")}]);
`;

await fs.writeFile(outPath, out, "utf8");
console.log(`Generated ${path.relative(projectRoot, outPath)} (${uniqueSortedCodes.length} codes)`);
